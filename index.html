<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Fallout: New Vegas Role Matcher (50Q)</title>
  <style>
    :root{
  --bg:#120a05;
  --bg2:#070402;
  --green:#ffb14a;        /* primary amber */
  --green2:#ff7a18;       /* hot orange */
  --panel:rgba(28,14,8,.88);
  --panel2:rgba(18,9,5,.78);
  --text:#ffd8a3;
  --muted:rgba(255,208,160,.76);
  --danger:#ff4b4b;
}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 30% 10%, rgba(255,170,70,.08), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(255,210,120,.04), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2) 60%, #000 120%);
      overflow-x:hidden;
    }

    /* CRT scanlines + vignette */
    .crt::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(0,0,0,.12),
          rgba(0,0,0,.12) 1px,
          rgba(0,0,0,0) 3px,
          rgba(0,0,0,0) 4px
        );
      mix-blend-mode: multiply;
      opacity:.55;
      z-index:9999;
    }
    .crt::after{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background: radial-gradient(closest-side, rgba(0,0,0,0), rgba(0,0,0,.55));
      opacity:.75;
      z-index:9998;
    }

    a{color:var(--green); text-decoration:none;}
    a:hover{text-decoration:underline;}

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 44px;
    }

    /* Pip-Boy style bezel */
    .pipboy{
      position:relative;
      border-radius: 28px;
      background:
        linear-gradient(180deg, rgba(24,12,7,.9), rgba(24,12,7,.92)),
        radial-gradient(500px 200px at 50% 0%, rgba(255,170,70,.10), transparent 70%);
      box-shadow: 0 28px 70px rgba(0,0,0,.65);
      border: 2px solid rgba(255,210,120,.14);
      padding: 18px;
    }
    .bezel{
      border-radius: 20px;
      border: 2px solid rgba(255,170,70,.28);
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.55);
      background: linear-gradient(180deg, rgba(24,12,7,.82), rgba(0,0,0,.65));
      overflow:hidden;
    }

    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,170,70,.22);
      background: linear-gradient(180deg, rgba(24,12,7,.72), rgba(24,12,7,.2));
    }
    .logo{
      width:40px;height:40px;border-radius:8px;
      border:1px solid rgba(255,170,70,.35);
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.55);
      display:grid;place-items:center;
      background: radial-gradient(circle at 30% 20%, rgba(255,170,70,.2), rgba(0,0,0,.25));
    }
    .logo svg{width:26px;height:26px;opacity:.9;}
    .title{
      flex:1;
      line-height:1.05;
    }
    .title h1{
      margin:0;
      font-size:16px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(255,236,210,.96);
    }
    .title .sub{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }
    .status-pill{
      font-size:12px;
      padding:6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(24,12,7,.55);
      color: rgba(255,236,210,.9);
      white-space:nowrap;
    }

    .content{
      padding: 14px;
    }

    .hero{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 12px;
      align-items:stretch;
    }
    @media (max-width: 820px){
      .hero{grid-template-columns:1fr;}
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--border2);
      border-radius: 16px;
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      padding: 12px 12px;
    }
    .panel h2{
      margin:0 0 8px;
      font-size:13px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(255,236,210,.92);
    }
    .panel p{margin:0 0 8px; color:var(--muted); font-size:12px; line-height:1.45;}
    .panel .small{font-size:11px;color:rgba(255,170,70,.62);}
    .panel .divider{height:1px;background:rgba(255,170,70,.18);margin:10px 0;}

    .btn{
      cursor:pointer;
      border:none;
      border-radius: 12px;
      padding: 12px 14px;
      color: rgba(0,0,0,.92);
      background: linear-gradient(180deg, rgba(255,170,70,.98), rgba(255,170,70,.92));
      font-weight: 800;
      letter-spacing:.06em;
      text-transform: uppercase;
      box-shadow: 0 10px 24px rgba(0,0,0,.45);
      width:100%;
    }
    .btn:disabled{
      cursor:not-allowed;
      opacity:.45;
      filter:grayscale(.25);
    }
    .btn.secondary{
      background: linear-gradient(180deg, rgba(255,210,120,.94), rgba(225,170,70,.9));
      color: rgba(0,0,0,.92);
    }

    .progress{
      display:flex; gap:10px; align-items:center; margin-top:10px;
    }
    .bar{
      flex:1; height:10px;
      border-radius: 999px;
      border:1px solid rgba(255,170,70,.25);
      background: rgba(0,0,0,.35);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.35);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,170,70,.9), rgba(255,210,120,.55));
    }
    .progress .pct{font-size:12px;color:var(--muted);white-space:nowrap;}

    .questions{
      margin-top: 12px;
      display:none;
    }
    .qcard{
      background: var(--panel2);
      border: 1px solid rgba(255,170,70,.22);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }
    .qmeta{
      display:flex; justify-content:space-between; gap:10px; align-items:baseline;
      margin-bottom: 8px;
    }
    .qnum{
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(255,170,70,.68);
    }
    .qtext{
      font-size:13px;
      color: rgba(255,236,210,.92);
      line-height:1.35;
      margin-top:4px;
    }
    .qtrait{
      font-size:11px;
      color: rgba(255,170,70,.8);
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .opts{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 10px;
    }
    .opt{
      display:flex; gap:10px; align-items:flex-start;
      border: 1px solid rgba(255,170,70,.18);
      background: rgba(0,0,0,.22);
      border-radius: 12px;
      padding: 10px 10px;
      cursor:pointer;
      transition: transform .06s ease, border-color .12s ease, background .12s ease;
    }
    .opt:hover{
      border-color: rgba(255,170,70,.32);
      background: rgba(255,170,70,.06);
    }
    .opt input{margin-top:2px; transform: scale(1.15);}
    .opt span{font-size:12px; color: rgba(255,236,210,.88); line-height:1.35;}
    .opt .tag{
      margin-left:auto;
      font-size:11px;
      color: rgba(255,170,70,.62);
      white-space:nowrap;
    }

    .submit-row{
      margin-top: 10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .submit-row .btn{flex:1; min-width:220px;}

    .results{
      display:none;
      margin-top: 14px;
    }

    .toprole{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap: 12px;
      align-items:stretch;
    }
    @media (max-width: 720px){
      .toprole{grid-template-columns:1fr;}
    }
    .roleimg{
      border-radius: 14px;
      border: 1px solid rgba(255,170,70,.22);
      background: rgba(0,0,0,.28);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.35);
      display:grid;place-items:center;
      min-height: 120px;
    }
    .roleimg img{
      width:100%; height:100%;
      object-fit: cover;
      filter: saturate(.9) contrast(1.05);
      opacity:.92;
    }
    .roleimg .noimg{
      font-size:11px;
      color: rgba(255,170,70,.6);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .toprole h3{
      margin:0;
      font-size:14px;
      letter-spacing:.10em;
      text-transform:uppercase;
    }
    .toprole .line{
      margin-top:6px;
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }
    .chips{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .chip{
      font-size:11px;
      border:1px solid rgba(255,170,70,.22);
      background: rgba(0,0,0,.22);
      padding: 5px 8px;
      border-radius: 999px;
      color: rgba(255,236,210,.86);
    }

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(255,170,70,.18);
      background: rgba(0,0,0,.22);
      margin-top: 10px;
    }
    th,td{
      padding:10px 10px;
      font-size:12px;
      text-align:left;
      border-bottom:1px solid rgba(255,170,70,.12);
    }
    th{
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(255,208,160,.76);
      background: rgba(24,12,7,.65);
    }
    tr:last-child td{border-bottom:none;}
    .right{text-align:right;}
    .muted{color:var(--muted);}
    .err{color:var(--danger);}
    .ok{color:rgba(255,170,70,.9);}
    .jump{
      display:inline-block;
      margin-top:8px;
      font-size:12px;
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,170,70,.22);
      background: rgba(0,0,0,.24);
    }

    .traitgrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    @media (max-width:720px){ .traitgrid{grid-template-columns:1fr;} }
    .titem{
      border:1px solid rgba(255,170,70,.16);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 10px;
    }
    .titem .k{font-size:11px;letter-spacing:.12em;text-transform:uppercase;color:rgba(255,208,160,.76);}
    .titem .v{margin-top:6px;font-size:14px;color:rgba(255,236,210,.92);display:flex;justify-content:space-between;align-items:baseline;}
    .titem .v b{font-size:14px;}
    .titem .meter{
      margin-top:8px;height:8px;border-radius:999px;border:1px solid rgba(255,170,70,.20);background:rgba(0,0,0,.35);overflow:hidden;
    }
    .titem .meter > div{height:100%;width:0%;background:linear-gradient(90deg, rgba(255,170,70,.9), rgba(255,210,120,.45));}

    .freq{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top:10px;
    }
    @media (max-width:820px){ .freq{grid-template-columns:1fr;} }
  
/* === Mojave Amber Pip-Boy Theme === */
body {
  background: #120C08;
}
.pipboy {
  box-shadow: 0 0 18px rgba(255,154,31,0.35);
}
.pipboy-panel, .panel {
  background: #1E140F;
  border-color: #FF9A1F;
}
h1, h2, h3, .title {
  color: #FF9A1F;
  text-shadow: 0 0 6px rgba(255,154,31,0.4);
}
button, .btn {
  background: transparent;
  border: 1px solid #FF9A1F;
  color: #FFD7A3;
}
button:hover, .btn:hover {
  background: rgba(255,154,31,0.15);
}

</style>
</head>
<body class="crt">
  <div class="wrap">
    <div class="pipboy">
      <div class="bezel">
        <div class="topbar">
          <div class="logo" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M4 7h16v10H4z" stroke="rgba(255,170,70,.9)" stroke-width="1.5"/>
              <path d="M7 10h10M7 13h7" stroke="rgba(255,170,70,.75)" stroke-width="1.5" stroke-linecap="round"/>
              <circle cx="19" cy="12" r="1.3" fill="rgba(255,210,120,.85)"/>
            </svg>
          </div>
          <div class="title">
            <h1>Role Matcher — Test 1 (50 Questions)</h1>
            <div class="sub">Pip‑Boy styled aptitude scan • Fallout: New Vegas theme</div>
          </div>
          <div id="libStatus" class="status-pill">Loading role library…</div>
        </div>

        <div class="content">
          <div class="hero">
            <div class="panel">
              <h2>Instructions</h2>
              <p>Answer <b>all 50</b> prompts. Each answer nudges 12 attributes: Leadership, Aggression, Autonomy, Risk Tolerance, Combat Exposure, Lethality Comfort, Empathy, Persuasion, Community Orientation, Technical Competence, Planning &amp; Logistics, Adaptability.</p>
              <p class="small">When you submit, your profile is matched against the loaded role library and your <b>Top 3</b> roles are shown.</p>
              <div class="divider"></div>
              <button id="startBtn" class="btn secondary" disabled>Start Test</button>
              <div class="progress">
                <div class="bar" aria-label="Progress"><div id="progFill"></div></div>
                <div id="progText" class="pct">0 / 50</div>
              </div>
              <a id="jumpLink" class="jump" href="#results" style="display:none;">Jump to results ↓</a>
            </div>

            <div class="panel">
              <h2>What this matches</h2>
              <p>Your answers build a 0–100 score for each trait. Roles in the library already have these same traits, so we compute similarity and return your closest fits.</p>
              <p class="small">Tip: Answer instinctively — don’t “game” it. The wasteland notices.</p>
              <div class="divider"></div>
              <div class="small">
                <div><b>Library source:</b> GitHub RAW</div>
                <div class="muted" style="margin-top:6px; word-break:break-all;">
                  https://raw.githubusercontent.com/JesterWolf/Fallout-Personality-Test/refs/heads/main/roles_v1.2A_trait_profiles_updated.json
                </div>
              </div>
            </div>
          </div>

          <div id="questions" class="questions" aria-live="polite"></div>

          <div id="submitRow" class="submit-row" style="display:none;">
            <button id="submitBtn" class="btn" disabled>Submit Answers</button>
            <button id="resetBtn" class="btn secondary">Reset</button>
          </div>

          <div id="results" class="results">
            <div class="panel">
              <h2>Top Match</h2>
              <div id="topRolePanel" class="toprole"></div>
            </div>

            <div class="panel" style="margin-top:12px;">
              <h2>Top 3 Results</h2>
              <div id="top3Table"></div>
            </div>

            <div class="panel" style="margin-top:12px;">
              <h2>Your trait profile</h2>
              <div id="traitGrid" class="traitgrid"></div>
            </div>

            <div class="panel" style="margin-top:12px;">
              <h2>Top 10 signals</h2>
              <p class="small">If tags or factions repeat a lot in your Top 10, it usually means you’re clustering around that style of role.</p>
              <div id="freqPanels" class="freq"></div>
            </div>
          </div>

          <div class="panel" style="margin-top:12px;">
            <h2>Trait legend</h2>
            <p class="small">
              <b>Authority / Agency</b>: Leadership, Aggression, Autonomy<br/>
              <b>Risk &amp; Violence</b>: Risk Tolerance, Combat Exposure, Lethality Comfort<br/>
              <b>Social Orientation</b>: Empathy, Persuasion, Community Orientation<br/>
              <b>Cognition &amp; Skill</b>: Technical Competence, Planning &amp; Logistics, Adaptability
            </p>
          </div>

        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const DEFAULT_URL = "https://raw.githubusercontent.com/JesterWolf/Fallout-Personality-Test/refs/heads/main/roles_v1.2A_trait_profiles_updated.json";

  const TRAITS = [
    ["A1","Leadership"],
    ["A2","Aggression"],
    ["A3","Autonomy"],
    ["B1","Risk Tolerance"],
    ["B2","Combat Exposure"],
    ["B3","Lethality Comfort"],
    ["C1","Empathy"],
    ["C2","Persuasion"],
    ["C3","Community Orientation"],
    ["D1","Technical Competence"],
    ["D2","Planning & Logistics"],
    ["D3","Adaptability"]
  ];

  // Exactly 50 questions (no more, no less).
  // Each question targets one trait. Options are scored -2..+2.
  const QUESTIONS = [
    // Leadership (A1) 1-4
    {t:"A1", q:"A crisis hits your group. What do you do first?", o:[
      "Take command immediately and assign tasks.",
      "Coordinate with others and propose a plan.",
      "Help where needed, but avoid leading.",
      "Wait to see who steps up.",
      "Avoid involvement; it’s not your problem."
    ]},
    {t:"A1", q:"If the team is split, you prefer to…", o:[
      "Settle it decisively and move on.",
      "Mediate and build consensus.",
      "Let people argue it out.",
      "Step aside and focus on your own work.",
      "Exploit the conflict for advantage."
    ]},
    {t:"A1", q:"In unfamiliar territory, you’re most comfortable when…", o:[
      "You’re in charge of decisions.",
      "You share leadership with a trusted peer.",
      "Someone else leads and you support.",
      "Everyone fends for themselves.",
      "No one has authority — chaos is fine."
    ]},
    {t:"A1", q:"A junior member keeps making mistakes. You…", o:[
      "Correct firmly and set standards.",
      "Coach them patiently.",
      "Ignore it unless it affects you.",
      "Complain to others, not them.",
      "Use them as a scapegoat."
    ]},

    // Aggression (A2) 5-8
    {t:"A2", q:"Someone disrespects you publicly. Your instinct is…", o:[
      "Confront hard and make it clear it won’t happen again.",
      "Respond firmly but controlled.",
      "Brush it off and move on.",
      "Avoid confrontation; it’s not worth it.",
      "Back down immediately."
    ]},
    {t:"A2", q:"When obstacles appear, you tend to…", o:[
      "Push through forcefully.",
      "Persist assertively.",
      "Work around them quietly.",
      "Delay and hope they resolve.",
      "Give up and disengage."
    ]},
    {t:"A2", q:"In negotiations, you prefer leverage that is…", o:[
      "Intimidating and unmistakable.",
      "Firm and credible.",
      "Neutral and fair.",
      "Soft and accommodating.",
      "You avoid negotiating at all."
    ]},
    {t:"A2", q:"If threatened, you’re most likely to…", o:[
      "Strike first.",
      "Prepare to strike if needed.",
      "Try to de-escalate.",
      "Withdraw if possible.",
      "Freeze and do nothing."
    ]},

    // Autonomy (A3) 9-12
    {t:"A3", q:"You work best when…", o:[
      "You set your own mission and methods.",
      "You have freedom within clear goals.",
      "You follow a structure with some flexibility.",
      "You have detailed instructions.",
      "Someone micromanages every step."
    ]},
    {t:"A3", q:"Rules are…", o:[
      "Optional if they slow the mission.",
      "Useful guidelines, but situational.",
      "Important for order.",
      "Best followed strictly.",
      "Essential — never deviate."
    ]},
    {t:"A3", q:"If leadership gives a bad order, you…", o:[
      "Refuse and act independently.",
      "Challenge it and propose alternatives.",
      "Follow it but adapt quietly.",
      "Follow it exactly.",
      "Follow it and blame leadership if it fails."
    ]},
    {t:"A3", q:"You prefer assignments that are…", o:[
      "Solo and self-directed.",
      "Small team with shared autonomy.",
      "Standard team tasks.",
      "Highly supervised roles.",
      "Purely routine with no decisions."
    ]},

    // Risk Tolerance (B1) 13-16
    {t:"B1", q:"A job pays well but is dangerous. You…", o:[
      "Take it — risk is part of the game.",
      "Take it if the odds are acceptable.",
      "Hesitate; you want more info first.",
      "Avoid it unless desperate.",
      "Never take it."
    ]},
    {t:"B1", q:"Unknown territory is…", o:[
      "Exciting — you go first.",
      "Worth exploring carefully.",
      "Something to approach slowly.",
      "Better left alone.",
      "Absolutely avoided."
    ]},
    {t:"B1", q:"When resources are scarce, you…", o:[
      "Gamble big to secure a decisive win.",
      "Take calculated risks.",
      "Conserve and play safe.",
      "Minimize exposure at all costs.",
      "Freeze — scarcity overwhelms you."
    ]},
    {t:"B1", q:"You trust your luck and instincts…", o:[
      "A lot — it’s kept you alive.",
      "Often, but you check yourself.",
      "Sometimes.",
      "Rarely.",
      "Never."
    ]},

    // Combat Exposure (B2) 17-20
    {t:"B2", q:"In a fight, you…", o:[
      "Move toward the action to end it fast.",
      "Hold a strong forward position.",
      "Support from a safer angle.",
      "Avoid engagement if possible.",
      "Run immediately."
    ]},
    {t:"B2", q:"You’re most valuable in conflict as…", o:[
      "Frontline fighter.",
      "Tactical shooter / maneuver.",
      "Support (med/tech/logistics).",
      "Observer / lookout.",
      "Not involved."
    ]},
    {t:"B2", q:"Gunfire nearby makes you feel…", o:[
      "Focused and energized.",
      "Alert and ready.",
      "Nervous but functional.",
      "Very anxious.",
      "Panicked."
    ]},
    {t:"B2", q:"If your group is attacked, you…", o:[
      "Counterattack aggressively.",
      "Defend and stabilize the line.",
      "Protect non-combatants first.",
      "Hide and wait it out.",
      "Flee without looking back."
    ]},

    // Lethality Comfort (B3) 21-24
    {t:"B3", q:"If killing is required to survive, you…", o:[
      "Do it without hesitation.",
      "Do it if necessary.",
      "Avoid it unless forced.",
      "Try to disable instead.",
      "Refuse, even at risk."
    ]},
    {t:"B3", q:"Your view on ‘mercy’ in conflict is…", o:[
      "A weakness enemies exploit.",
      "Situational, but rare.",
      "Important when possible.",
      "A guiding principle.",
      "Always mandatory."
    ]},
    {t:"B3", q:"A captured enemy is…", o:[
      "A liability — eliminate.",
      "A bargaining chip.",
      "Someone to disarm and release.",
      "Someone to heal/rehabilitate.",
      "Never your concern."
    ]},
    {t:"B3", q:"You’re comfortable carrying weapons because…", o:[
      "Power matters.",
      "Protection matters.",
      "It’s practical.",
      "You’d rather not, but must.",
      "You avoid weapons entirely."
    ]},

    // Empathy (C1) 25-28
    {t:"C1", q:"Someone is grieving. You…", o:[
      "Stay distant — feelings slow the mission.",
      "Offer brief support, then refocus.",
      "Listen and comfort them.",
      "Make time to help them recover.",
      "Put their needs above everything."
    ]},
    {t:"C1", q:"You judge people mostly by…", o:[
      "Usefulness and results.",
      "Reliability.",
      "Intentions and effort.",
      "Their struggles and context.",
      "Their feelings above all."
    ]},
    {t:"C1", q:"If a stranger needs help, you…", o:[
      "Ignore them unless it benefits you.",
      "Help if it’s low cost.",
      "Help if it’s reasonable.",
      "Help even if inconvenient.",
      "Help even if it risks you."
    ]},
    {t:"C1", q:"When someone makes a mistake, you assume…", o:[
      "They’re incompetent.",
      "They didn’t think.",
      "They tried, but failed.",
      "They were under pressure.",
      "They deserve patience and care."
    ]},

    // Persuasion (C2) 29-32
    {t:"C2", q:"To get what you want, you rely on…", o:[
      "Pressure and dominance.",
      "Firm negotiation.",
      "Reason and compromise.",
      "Charm and rapport.",
      "You avoid asking."
    ]},
    {t:"C2", q:"In a tense room, you usually…", o:[
      "Control the room with presence.",
      "Speak up confidently.",
      "Blend in and observe.",
      "Support someone else’s lead.",
      "Go silent and withdraw."
    ]},
    {t:"C2", q:"You’re best at…", o:[
      "Getting compliance.",
      "Winning arguments.",
      "Finding mutual benefit.",
      "Getting people to like you.",
      "Avoiding interaction."
    ]},
    {t:"C2", q:"If you need information from someone, you…", o:[
      "Threaten or corner them.",
      "Apply pressure and incentives.",
      "Ask directly and fairly.",
      "Build trust and coax it out.",
      "Give up quickly."
    ]},

    // Community Orientation (C3) 33-36
    {t:"C3", q:"You prefer resources to be…", o:[
      "Owned by whoever can hold them.",
      "Controlled by leadership.",
      "Shared with rules.",
      "Shared widely to protect people.",
      "Given away whenever asked."
    ]},
    {t:"C3", q:"Your ideal group is…", o:[
      "A hierarchy with clear winners.",
      "A disciplined team.",
      "A balanced community.",
      "A cooperative family-like network.",
      "No group at all."
    ]},
    {t:"C3", q:"If your settlement is threatened, you…", o:[
      "Prioritize defending key assets.",
      "Organize a strong defense.",
      "Help coordinate community safety.",
      "Focus on protecting the vulnerable.",
      "Leave before it gets worse."
    ]},
    {t:"C3", q:"Loyalty means…", o:[
      "Strength and obedience.",
      "Reliability under pressure.",
      "Mutual support.",
      "Care for the group’s wellbeing.",
      "Nothing — loyalty is a trap."
    ]},

    // Technical Competence (D1) 37-40
    {t:"D1", q:"A broken machine is…", o:[
      "Something you can rebuild from scrap.",
      "A puzzle you can usually fix.",
      "Something you can manage with help.",
      "Something you avoid touching.",
      "Totally beyond you."
    ]},
    {t:"D1", q:"When you face a new tool/system, you…", o:[
      "Master it quickly and improve it.",
      "Learn it fast with practice.",
      "Learn basics to get by.",
      "Struggle and need guidance.",
      "Avoid it completely."
    ]},
    {t:"D1", q:"You trust technology…", o:[
      "Deeply — it’s the path forward.",
      "When it’s proven.",
      "In moderation.",
      "Not much.",
      "Not at all."
    ]},
    {t:"D1", q:"Your practical strengths are…", o:[
      "Engineering and building.",
      "Repair and maintenance.",
      "Basic handiwork.",
      "Minimal hands-on skill.",
      "None."
    ]},

    // Planning & Logistics (D2) 41-44
    {t:"D2", q:"Before a job, you…", o:[
      "Plan contingencies and routes thoroughly.",
      "Make a solid plan with backups.",
      "Do a basic plan and adjust later.",
      "Mostly wing it.",
      "Avoid planning entirely."
    ]},
    {t:"D2", q:"Your pack and supplies are…", o:[
      "Optimized and mission-ready.",
      "Well-prepared.",
      "Adequate.",
      "Often missing essentials.",
      "A mess."
    ]},
    {t:"D2", q:"In a group, you naturally handle…", o:[
      "Strategy, logistics, and allocation.",
      "Planning and coordination.",
      "A specific task role.",
      "Whatever comes up randomly.",
      "Nothing — you drift."
    ]},
    {t:"D2", q:"When things go wrong, you…", o:[
      "Execute a contingency calmly.",
      "Re-plan quickly.",
      "Improvise with mixed results.",
      "Panic and scramble.",
      "Shut down."
    ]},

    // Adaptability (D3) 45-50
    {t:"D3", q:"If the plan collapses, you…", o:[
      "Switch tactics instantly.",
      "Adapt with a new plan.",
      "Adjust gradually.",
      "Stick to the original plan.",
      "Freeze."
    ]},
    {t:"D3", q:"New people and cultures…", o:[
      "You read them fast and blend in.",
      "You adapt with effort.",
      "You tolerate them.",
      "You struggle to adjust.",
      "You reject them."
    ]},
    {t:"D3", q:"Under sudden pressure, you…", o:[
      "Get sharper.",
      "Stay steady.",
      "Manage with effort.",
      "Get overwhelmed.",
      "Break down."
    ]},
    {t:"D3", q:"When rules change midstream, you…", o:[
      "Use it as an advantage.",
      "Update and continue.",
      "Complain but comply.",
      "Get stuck.",
      "Quit."
    ]},
    {t:"D3", q:"A weird problem no one’s seen before is…", o:[
      "Your favorite kind of challenge.",
      "Interesting and solvable.",
      "Annoying but manageable.",
      "Something you avoid.",
      "A dead end."
    ]},
    {t:"D3", q:"Your identity is best described as…", o:[
      "A flexible operator: whatever the job needs.",
      "Adaptable but with a core style.",
      "Mostly consistent.",
      "Rigid — you don’t change much.",
      "You’re stuck in your ways."
    ]}
  ];

  if (QUESTIONS.length !== 50){
    console.error("Question count is not 50:", QUESTIONS.length);
  }

  const libStatus = document.getElementById("libStatus");
  const startBtn = document.getElementById("startBtn");
  const questionsEl = document.getElementById("questions");
  const submitRow = document.getElementById("submitRow");
  const submitBtn = document.getElementById("submitBtn");
  const resetBtn = document.getElementById("resetBtn");
  const progFill = document.getElementById("progFill");
  const progText = document.getElementById("progText");
  const resultsEl = document.getElementById("results");
  const topRolePanel = document.getElementById("topRolePanel");
  const top3Table = document.getElementById("top3Table");
  const traitGrid = document.getElementById("traitGrid");
  const freqPanels = document.getElementById("freqPanels");
  const jumpLink = document.getElementById("jumpLink");

  let ROLE_LIBRARY = [];
  let answers = new Array(QUESTIONS.length).fill(null);

  const scoreMap = [-2,-1,0,1,2];
  const optLabels = ["Strongly Disagree","Disagree","Neutral","Agree","Strongly Agree"];

  function normalizeId(s){
    return String(s||"").trim().toUpperCase().replace(/[^A-Z0-9]+/g,"_").replace(/^_+|_+$/g,"");
  }

  function setProgress(){
    const answered = answers.filter(v => v !== null).length;
    const pct = Math.round((answered / QUESTIONS.length) * 100);
    progFill.style.width = pct + "%";
    progText.textContent = `${answered} / ${QUESTIONS.length}`;
    submitBtn.disabled = answered !== QUESTIONS.length || ROLE_LIBRARY.length === 0;
  }

  function renderQuestions(){
    questionsEl.innerHTML = "";
    QUESTIONS.forEach((q, idx) => {
      const traitName = (TRAITS.find(x=>x[0]===q.t) || [q.t,q.t])[1];
      const card = document.createElement("div");
      card.className = "qcard";
      card.innerHTML = `
        <div class="qmeta">
          <div>
            <div class="qnum">Question ${idx+1} / ${QUESTIONS.length}</div>
            <div class="qtext">${q.q}</div>
          </div>
          <div class="qtrait">${traitName}</div>
        </div>
        <div class="opts" role="radiogroup" aria-label="Question ${idx+1}">
          ${q.o.map((txt, i) => {
            const id = `q${idx}_o${i}`;
            return `
              <label class="opt" for="${id}">
                <input type="radio" name="q${idx}" id="${id}" value="${i}">
                <span>${txt}</span>
                <span class="tag">${optLabels[i]}</span>
              </label>
            `;
          }).join("")}
        </div>
      `;
      questionsEl.appendChild(card);

      card.querySelectorAll(`input[name="q${idx}"]`).forEach(r => {
        r.addEventListener("change", () => {
          answers[idx] = parseInt(r.value, 10);
          setProgress();
        });
      });
    });

    setProgress();
  }

  function computeTraitScores(){
    // For each trait: average contribution (-2..+2), normalize to 0..100
    const sums = {};
    const counts = {};
    TRAITS.forEach(([k]) => { sums[k]=0; counts[k]=0; });

    answers.forEach((a, idx) => {
      const q = QUESTIONS[idx];
      if (a === null) return;
      const v = scoreMap[a]; // -2..+2
      sums[q.t] += v;
      counts[q.t] += 1;
    });

    const out = {};
    TRAITS.forEach(([k]) => {
      const n = counts[k] || 1;
      const avg = sums[k] / n; // -2..+2
      out[k] = Math.round(((avg + 2) / 4) * 100); // 0..100
    });
    return out;
  }

  function roleScorePct(userTraits, role){
    // Similarity: 100 - mean absolute error (0..100) mapped to 0..100
    const diffs = [];
    for (const [k] of TRAITS){
      const rt = role.traits?.[k];
      const ut = userTraits[k];
      if (typeof rt !== "number") continue;
      diffs.push(Math.abs(rt - ut));
    }
    const mae = diffs.reduce((a,b)=>a+b,0) / (diffs.length || 1);
    const pct = Math.max(0, Math.min(100, 100 - mae));
    return pct;
  }

  function formatPct(x){
    return (Math.round(x*10)/10).toFixed(1) + "%";
  }

  function countTopSignals(topN){
    const tagCounts = new Map();
    const factionCounts = new Map();

    topN.forEach(r => {
      const f = r.faction || "Unknown";
      factionCounts.set(f, (factionCounts.get(f)||0)+1);
      (r.tags || []).forEach(t => tagCounts.set(t, (tagCounts.get(t)||0)+1));
    });

    const sortMap = (m) => [...m.entries()].sort((a,b)=>b[1]-a[1]);
    return {
      factions: sortMap(factionCounts).slice(0,10),
      tags: sortMap(tagCounts).slice(0,12)
    };
  }

  function renderResults(userTraits, scored){
    resultsEl.style.display = "block";
    jumpLink.style.display = "inline-block";
    jumpLink.href = "#results";

    const top = scored[0];
    const imgHtml = (top.img && String(top.img).trim().length)
      ? `<img src="${top.img}" alt="${top.faction} — ${top.role}" loading="lazy" onerror="this.closest('.roleimg').innerHTML='<div class=&quot;noimg&quot;>No Image</div>';">`
      : `<div class="noimg">No Image</div>`;

    const tags = (top.tags || []).slice(0,16);
    topRolePanel.innerHTML = `
      <div class="roleimg">${imgHtml}</div>
      <div>
        <h3>${top.faction} — ${top.role} <span class="muted">(${formatPct(top._scorePct)})</span></h3>
        <div class="line">${top.notes ? top.notes : "<span class='muted'>No notes in library for this role.</span>"}</div>
        <div class="chips">
          ${tags.length ? tags.map(t=>`<span class="chip">${t}</span>`).join("") : `<span class="muted">No tags</span>`}
        </div>
        <a class="jump" href="#top3">Jump to Top 3 ↓</a>
      </div>
    `;

    top3Table.innerHTML = `
      <table id="top3">
        <thead><tr><th>Faction</th><th>Role</th><th class="right">Score (%)</th></tr></thead>
        <tbody>
          ${scored.slice(0,3).map(r=>`
            <tr>
              <td>${r.faction||""}</td>
              <td>${r.role||""}</td>
              <td class="right">${formatPct(r._scorePct)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;

    traitGrid.innerHTML = TRAITS.map(([k,label]) => {
      const v = userTraits[k];
      return `
        <div class="titem">
          <div class="k">${label}</div>
          <div class="v"><b>${v}</b><span class="muted">/ 100</span></div>
          <div class="meter"><div style="width:${v}%;"></div></div>
        </div>
      `;
    }).join("");

    const top10 = scored.slice(0,10);
    const sig = countTopSignals(top10);

    const factionRows = sig.factions.length
      ? sig.factions.map(([name,count]) => `<tr><td>${name}</td><td class="right">${count}</td></tr>`).join("")
      : `<tr><td class="muted">None</td><td class="right">0</td></tr>`;
    const tagRows = sig.tags.length
      ? sig.tags.map(([name,count]) => `<tr><td>${name}</td><td class="right">${count}</td></tr>`).join("")
      : `<tr><td class="muted">None</td><td class="right">0</td></tr>`;

    freqPanels.innerHTML = `
      <div>
        <table>
          <thead><tr><th colspan="2">Faction frequency (Top 10)</th></tr></thead>
          <tbody>${factionRows}</tbody>
        </table>
      </div>
      <div>
        <table>
          <thead><tr><th colspan="2">Tag frequency (Top 10)</th></tr></thead>
          <tbody>${tagRows}</tbody>
        </table>
      </div>
    `;
  }

  async function loadDefaultLibrary(){
    try{
      libStatus.textContent = "Loading role library…";
      const res = await fetch(DEFAULT_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if (!Array.isArray(data)) throw new Error("Library JSON is not an array");
      // Basic validation + normalize
      ROLE_LIBRARY = data
        .filter(x => x && typeof x === "object" && x.traits && typeof x.traits === "object")
        .map(x => ({
          id: x.id || `${normalizeId(x.faction)}__${normalizeId(x.role)}`,
          faction: x.faction || "Unknown",
          role: x.role || "Unknown",
          traits: x.traits || {},
          variance: x.variance ?? null,
          tags: Array.isArray(x.tags) ? x.tags : [],
          notes: x.notes || "",
          img: x.img || ""
        }));

      if (ROLE_LIBRARY.length === 0) throw new Error("No valid role entries found.");
      libStatus.innerHTML = `<span class="ok">Library loaded:</span> ${ROLE_LIBRARY.length} roles`;
      startBtn.disabled = false;
      submitBtn.disabled = true; // until answers done
    }catch(e){
      console.error(e);
      libStatus.innerHTML = `<span class="err">Library failed:</span> ${String(e.message || e)}`;
      startBtn.disabled = true;
    }
  }

  function resetAll(){
    answers = new Array(QUESTIONS.length).fill(null);
    resultsEl.style.display = "none";
    questionsEl.style.display = "none";
    submitRow.style.display = "none";
    startBtn.style.display = "inline-block";
    // clear radios
    document.querySelectorAll("input[type=radio]").forEach(r => r.checked = false);
    setProgress();
    window.scrollTo({top:0, behavior:"smooth"});
  }

  startBtn.addEventListener("click", () => {
    startBtn.style.display = "none";
    questionsEl.style.display = "block";
    submitRow.style.display = "flex";
    renderQuestions();
    window.scrollTo({top: 210, behavior:"smooth"});
  });

  resetBtn.addEventListener("click", resetAll);

  submitBtn.addEventListener("click", () => {
    if (submitBtn.disabled) return;
    const userTraits = computeTraitScores();
    const scored = ROLE_LIBRARY
      .map(r => {
        const pct = roleScorePct(userTraits, r);
        return {...r, _scorePct: pct};
      })
      .sort((a,b) => b._scorePct - a._scorePct);

    renderResults(userTraits, scored);
    window.scrollTo({top: document.getElementById("results").offsetTop - 10, behavior:"smooth"});
  });

  // init
  loadDefaultLibrary();
  setProgress();
})();
</script>
</body>
</html>
